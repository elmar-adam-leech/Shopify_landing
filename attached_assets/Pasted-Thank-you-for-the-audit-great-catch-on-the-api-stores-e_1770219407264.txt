Thank you for the audit — great catch on the /api/stores/* endpoints and missing filters on call-logs/analytics/submissions.

Please proceed with the implementation, but expand the plan to include these additional protections (defense-in-depth):

1. Enforce storeId in EVERY Drizzle query (e.g., always add .where(eq(table.storeId, req.storeContext.storeId)) even if middleware passed — prevents accidental leaks if middleware is bypassed).
2. Encrypt sensitive PII at rest:
   - In formSubmissions and callLogs tables: encrypt phone, email, name before insert (use crypto module + AES-256-GCM with per-store key derived from SHOPIFY_API_SECRET + storeId salt).
   - Add encrypt/decrypt helpers in a new lib/crypto.ts.
3. Add audit logging for ALL access attempts to sensitive endpoints:
   - On 401/403: log { shop, attemptedStoreId, ip, userAgent, endpoint } to a new auditLogs table (create schema if needed).
4. Disable /api/test/* endpoints completely in production (check process.env.NODE_ENV !== 'production').
5. Add per-store rate limiting on all /api/* endpoints (use express-rate-limit, key by req.storeContext?.storeId || ip).
6. For future app proxy support: prepare by adding a verifyProxySignature helper (using crypto.createHmac('sha256', apiSecret).update(sortedQueryString).digest('hex') and compare to req.query.signature — reference Shopify docs: https://shopify.dev/docs/apps/build/online-store/app-proxies/authenticate-app-proxies).

Updated task priority:
- Fix /api/stores/* endpoints first (restrict to authenticated user's assigned stores — assume userStoreAssignments table exists for now; if not, add simple ownership check via pages or sessions).
- Then secure call-logs, tracking-numbers, analytics, submissions with strict storeId filters + context validation.
- Add encryption for PII.
- Implement audit logging.
- Add rate limiting.

First: show me an updated detailed plan (files to create/change, new table if needed, code structure for encryption & audit).
Include example code snippets for:
- Encryption helper
- Audit log insert
- Rate limit config

Then show diffs or file-by-file changes — do NOT apply anything yet until I approve.